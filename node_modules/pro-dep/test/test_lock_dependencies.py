from subprocess import check_call

from helpers import git_log


def test_lock_dependencies(dep_cmd, bower_components_path, node_modules_path):
    assert check_call(['npm', 'install', '--save', 'underscore@1.5.2']) == 0
    assert check_call(['npm', 'install', 'underscore']) == 0
    assert check_call(['bower', 'install', '--save', 'underscore#1.5.2']) == 0
    assert check_call(['bower', 'install', 'jasmine']) == 0

    assert check_call(['git', 'add', '.']) == 0
    assert check_call(['git', 'commit', '--amend', '-m', '(TEST) Initial.']) == 0

    assert check_call([dep_cmd, 'lock-project-dependencies']) == 0

    with open('.gitignore', 'r') as f:
        assert '**/.bin\n' in f.readlines()

    assert bower_components_path.join('underscore').check()
    assert bower_components_path.join('jasmine').check() is False

    assert node_modules_path.join('underscore').check()

    log = git_log()
    assert len(log) == 5
    bow_log = "(DEP) Install bower component '{name}'"
    npm_log = "(DEP) Install npm package '{name}'"
    assert log[0] == bow_log.format(name='underscore')
    assert log[1] == '(DEP) Fresh start on app/bower_components.'
    assert log[2] == npm_log.format(name='underscore')
    assert log[3] == '(DEP) Fresh start on node_modules.'
    assert log[4] == '(TEST) Initial.'
