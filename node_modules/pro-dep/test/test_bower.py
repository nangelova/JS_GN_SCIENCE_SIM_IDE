import json
from subprocess import check_call

import pytest

from helpers import make_install_str, git_log


@pytest.mark.parametrize('name,version,url', [
    ('jquery', None, None),
    ('jquery', '2.1.0', None),
    ('jquery', '2.1.0', 'https://github.com/jquery/jquery.git#2.1.0')
])
def test_bower_install(dep_cmd, bower_components_path, name, version, url):
    install_str = make_install_str(name, version, url, '#')

    assert check_call([dep_cmd, 'bower-install', install_str]) == 0

    with bower_components_path.join(name, 'bower.json').open() as f:
        bower_json = json.loads(f.read())
        if version is not None:
            assert version == bower_json['version']

    with open('bower.json') as f:
        bower_json = json.loads(f.read())
        assert name in bower_json['dependencies']
        if version is not None:
            assert version in bower_json['dependencies'][name]

    log = git_log()
    assert len(log) == 2
    assert "(DEP) Install bower component '{name}'".format(name=name) == log[0]
